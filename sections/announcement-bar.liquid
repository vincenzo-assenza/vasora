{% if section.blocks.size > 0 %}
  <section
    class="announcement-bar{% if section.settings.full_width %} full-width{% endif %}"
    role="region"
    aria-label="{{ section.settings.aria_label | default: 'Announcement bar' }}"
    aria-live="{% if section.settings.autoplay and section.blocks.size > 1 %}off{% else %}polite{% endif %}"
    data-announcement-bar
    data-autoplay="{{ section.settings.autoplay }}"
    data-autoplay-speed="{{ section.settings.autoplay_speed | default: 4 }}"
    style="--announcement-bg: {{ section.settings.background_color }}; --announcement-text: {{ section.settings.text_color }}; --announcement-border: {{ section.settings.border_color }};"
  >
    <div class="announcement-bar__inner{% unless section.settings.full_width %} u-container{% endunless %}">
      <div class="announcement-bar__viewport" data-announcement-viewport>
        <div class="announcement-bar__track" data-announcement-track>
          {% for block in section.blocks %}
            {% assign content = block.settings.content %}
            {% if content != blank %}
              <div
                class="announcement-bar__slide"
                data-announcement-slide
                {{ block.shopify_attributes }}
              >
                <div class="announcement-bar__item rte">{{ content }}</div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
{% endif %}

<style>
  #shopify-section-{{ section.id }} {
    display: block;
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0;
  }
</style>

{% stylesheet %}
  .announcement-bar {
    background: var(--announcement-bg, var(--color-background));
    color: var(--announcement-text, var(--color-foreground));
    border-bottom: 1px solid var(--announcement-border, var(--color-border));
    min-height: 2.2rem;
    display: flex;
    align-items: center;
  }

  .announcement-bar.full-width {
    width: 100vw;
    max-width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .announcement-bar__inner {
    width: 100%;
    margin: 0 auto;
    padding: 0.45rem var(--container-padding-inline);
  }

  .announcement-bar__viewport {
    overflow: hidden;
    width: 100%;
  }

  .announcement-bar__track {
    display: flex;
    width: 100%;
    transform: translateX(0);
    transition: transform 360ms ease;
    will-change: transform;
  }

  .announcement-bar__slide {
    flex: 0 0 100%;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .announcement-bar__item {
    margin: 0;
    padding: 0.2rem 0.4rem;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: fit-content;
    max-width: 100%;
    text-align: center;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: 1px solid var(--announcement-border, var(--color-border));
  }

  .announcement-bar__item p {
    margin: 0;
    text-align: center;
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const sectionRoot = document.getElementById('shopify-section-{{ section.id }}');
    if (!sectionRoot) return;

    const root = sectionRoot.querySelector('[data-announcement-bar]');
    if (!root) return;

    const track = root.querySelector('[data-announcement-track]');
    const slides = Array.from(root.querySelectorAll('[data-announcement-slide]'));

    if (!track || slides.length <= 1) return;

    let index = 0;

    const goTo = (nextIndex) => {
      index = nextIndex;
      track.style.transform = `translateX(-${index * 100}%)`;
    };

    const autoplay = root.dataset.autoplay === 'true';
    if (!autoplay || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const speedSeconds = Number(root.dataset.autoplaySpeed);
    const intervalMs = Number.isFinite(speedSeconds) && speedSeconds > 0 ? speedSeconds * 1000 : 4000;

    setInterval(() => {
      goTo((index + 1) % slides.length);
    }, intervalMs);
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Announcement bar",
  "enabled_on": {
    "groups": ["header"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Autoplay speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#ffffff33"
    },
    {
      "type": "text",
      "id": "aria_label",
      "label": "Aria label",
      "default": "Announcement bar"
    }
  ],
  "blocks": [
    {
      "type": "announcement",
      "name": "Announcement",
      "limit": 5,
      "settings": [
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Free shipping on orders over â‚¬50</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Announcement bar",
      "blocks": [
        {
          "type": "announcement"
        }
      ]
    }
  ]
}
{% endschema %}
